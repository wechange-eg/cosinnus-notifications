{% extends "cosinnus_notifications/base.html" %}
{% load i18n static cosinnus_tags djajax_tags widget_tweaks %}

{% block page_title %}
    {% trans "Notification Preferences" %}
{% endblock page_title %}

{% block breadcrumb %}
    {{ block.super }}
    <li class="active">{% trans "Notification Preferences" %}</li>
{% endblock %}

{% block leftnav %}
    {% include 'cosinnus/user/leftnav.html' with view="edit_notifications" %}
{% endblock leftnav %}

{% block content %}
    
    {% if not request.user|cosinnus_setting:"notifications_help_text" %}
	    <div class="alert alert-success alert-dismissable">
	        <i class="fa fa-info-circle fa-3x"></i>
	        <button id="close_button" type="button" class="close" data-dismiss="alert" aria-hidden="true" {% djajax_connect request.user.cosinnus_profile.settings trigger_on="click" fixed_value="notifications_help_text:true" %}>&#215;</button>
	        <p>{% trans "Select which notifications you would like to receive for each group or project you are involved in." %}</p>
	        <p>{% trans "These notifications will be sent to your configured email address:" %} <em>{{ request.user.email }}</em></p>
	    </div>
    {% endif %}

    <form method="POST" action="">{% csrf_token %}
		<!-- a box with semi transparent background -->
	    <div class="content-box">
            {% for group, notifications, choice in grouped_notifications %}
                <div class="row large-space">
	                <div class="col-md-12"><!-- right column -->
	                    {% if not notifications and not choice %}
	                        <a href="{% group_url 'cosinnus:group-dashboard' group=group.slug %}" target="_blank"> 
                                <legend>{{ group.name }}</legend>
                            </a>
	                    {% else %}
		                    <div class="row">
		                        {% if group.parent %}
		                        <div class="col-md-1">
		                            <legend>&nbsp;</legend>
		                        </div>
		                        {% endif %}
		                        <div class="{% if group.parent %}col-md-3{% else %}col-md-4{% endif %}">
		                            <a href="{% group_url 'cosinnus:group-dashboard' group=group.slug %}" target="_blank"> 
		                                <legend>{{ group.name }}</legend>
		                            </a>
		                        </div>
		                        <div class="col-md-8">
		                            <p class="no-horizontal-padding no-vertical-padding">
		                            <select id="notif_choice_{{group.pk}}" name="notif_choice:{{group.pk}}" class="form-control" onchange="toggleCustomNotificationPreferences({{group.pk}});" onmousedown="return toggleCustomNotificationHeader(event, {{group.pk}});">
		                                <option {% if choice == "all" %}selected{% endif %} value="all">{% trans "All notifications" %}</option>
		                                <option default {% if choice == "custom" %}selected{% endif %} value="custom">{% trans "Custom" %}</option>
		                                <option {% if choice == "none" %}selected{% endif %} value="none">{% trans "No notifications" %}</option>
		                            </select>
		                            </p>
		                        </div>
		                    </div>
		                    <div id="div_notif_choices_{{group.pk}}" style="display:none;">
	                            {% for id, label, value, app_name, app_label in notifications %}
		                            <div class="row"> 
		                                <div class="col-md-3 col-md-offset-1">
                                            {% ifchanged app_label %}
                                                <label>{{ app_label }}</label>
                                            {% endifchanged %}&nbsp;
                                        </div>
		                                <div class="col-md-8">
			                                <div {% ifchanged app_name %}style="border-top: solid 1px gray;"{% endifchanged %}>
				                                <input type="hidden" value="0" name="notif_option:{{id}}" /> <!-- will send unchecked data on POST -->
				                                <label><input type="checkbox" name="notif_option:{{id}}" value="1" {% if value %}checked="true"{% endif %} /> {{label}}</label>
			                                </div>
		                                </div>
		                            </div>    
	                            {% endfor %}
		                    </div>
		                {% endif %}
	                </div>
                </div>
            {% endfor %}
        </div><!-- content-box -->
        
        <button type="submit" class="btn btn-emphasized">
            <ul class="media-list">
                <li class="media">
                    <a class="pull-left" href="#">
                        <i class="fa fa-check"></i>
                    </a>
                    <div class="media-body">
                        {% trans "Save" %}
                    </div>
                </li>
            </ul>
        </button>
    
    </form>
{% endblock content %}


{% block extrafooter %}
    {{ block.super }}
    <script type="text/javascript">
        var toggleCustomNotificationPreferences = function(id) {
            var pref_box = $('#notif_choice_' + id);
            var pref_area = $('#div_notif_choices_' + id);
            if (pref_box.val() == 'custom') {
                pref_area.show();
            } else {
                pref_area.hide();
            }
        };
        var toggleCustomNotificationHeader = function(e, id) {
            var pref_box = $('#notif_choice_' + id);
            var pref_area = $('#div_notif_choices_' + id);
            if (pref_box.val() == 'custom' && !pref_area.is(':visible')) {
                pref_area.show();
                e.preventDefault();
                return false;
            }
            return true;
        };
    </script>
{% endblock extrafooter %}